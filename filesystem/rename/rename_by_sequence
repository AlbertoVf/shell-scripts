#!/usr/bin/env python
# ? description : Rename file by date creation. Rename file to "name_YYYY-MM-DD.extension".
# ? usage       : rename_sequential [directory|none]

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _log, _success, _error, _params_required


def _rn(old_path: Path, new_path: Path) -> bool:
    if new_path != old_path:
        old_path.rename(new_path)
        _success(f"mv {old_path.name} -> {new_path.name}")
        return True
    return False


def name_with_date(files: list[Path]) -> None:
    from datetime import datetime

    for file in files:
        name, extension = file.stem, file.suffix
        timestamp = file.stat().st_ctime
        date = datetime.fromtimestamp(timestamp).strftime("%Y-%m-%d")
        new_name = file.parent / f"{name}_{date}{extension}"
        _rn(file, new_name)


def with_numeric_sequence(files: list[Path], with_folder: bool = False) -> None:
    folder = files[0].parent if files else Path.cwd()
    padding = len(str(len(files)))

    for i, file in enumerate(files, start=1):
        new_name = f"{str(i).zfill(padding)}{file.suffix}"

        if with_folder:
            new_name = file.parent.name + new_name
        _rn(file, folder / new_name)


if __name__ == "__main__":
    folders = [Path(f) for f in sys.argv[2:]] if len(sys.argv) > 2 else [Path.cwd()]

    for folder in folders:
        if not folder.exists() or not folder.is_dir():
            _error(f"'{folder}' no es un directorio válido")
            continue

        files = sorted(
            [f for f in folder.iterdir() if f.is_file()],
            key=lambda f: f.name,
        )

        if not files:
            _log(f"No hay archivos en '{folder}'")
            continue

        mode = sys.argv[1]

        if mode == "-d":
            name_with_date(files)
        elif mode == "-n":
            with_numeric_sequence(files, True)
        elif mode == "-s":
            with_numeric_sequence(files, False)
        else:
            _error(f"Modo inválido: {mode}. Use -d, -n o -s")

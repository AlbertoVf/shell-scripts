#!/usr/bin/env python
# ? description: Convert video to mp4 format.
# ? usage      : to_mp4 [video(s)]

import sys
from pathlib import Path
from subprocess import run, DEVNULL

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _log, _success, _error, _params_required


def convert_video(input_path: Path) -> bool:
    """Convert a single video file to MP4 format."""
    output_path = input_path.parent / f"{input_path.stem}.mp4"
    _log(f"Procesando: {input_path.name}")

    result = run(
        ["ffmpeg", "-y", "-i", str(input_path),
         "-c:v", "libx265", "-crf", "23", "-preset", "medium",
         "-c:a", "aac", "-b:a", "192k",
         str(output_path)],
        stdout=DEVNULL,
        stderr=DEVNULL,
        check=False
    )
    return result.returncode == 0


if __name__ == "__main__":
    _params_required(1)

    files = [Path(f) for f in sys.argv[1:] if Path(f).exists() and Path(f).is_file()]

    if not files:
        _error("No se encontraron archivos v√°lidos")
        sys.exit(1)

    if len(files) == 1:
        file = files[0]
        if convert_video(file):
            _success(f"Convertido {file.name}")
        else:
            _error(f"Error al convertir {file.name}")
    else:
        from concurrent.futures import ProcessPoolExecutor, as_completed

        with ProcessPoolExecutor() as executor:
            futures = {executor.submit(convert_video, f): f for f in files}

            for future in as_completed(futures):
                file = futures[future]
                try:
                    if future.result():
                        _success(f"Convertido {file.name}")
                    else:
                        _error(f"Error al convertir {file.name}")
                except Exception as e:
                    _error(f"Error inesperado con {file.name}: {e}")

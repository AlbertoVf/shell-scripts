#!/usr/bin/env python
# ? description: Convert video to mkv format.
# ? usage      : to_mkv [video(s)]

import sys
from pathlib import Path
from subprocess import run, DEVNULL

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _message, _params_required, _valid_files


def convert_video(input_path: Path) -> bool:
    """Convert a single video file to MKV format."""
    output_path = input_path.parent / f"{input_path.stem}.mkv"
    _message.log(f"Procesando: {input_path.name}")

    result = run(
        ["ffmpeg", "-y", "-i", str(input_path),
         "-c:v", "libx265", "-preset", "slow", "-crf", "23",
         "-c:a", "aac", "-b:a", "192k",
         str(output_path)],
        stdout=DEVNULL,
        stderr=DEVNULL,
        check=False
    )
    return result.returncode == 0


if __name__ == "__main__":
    _params_required(1)


    files = _valid_files(sys.argv[1:])

    if len(files) == 1:
        file = files[0]
        if convert_video(file):
            _message.success(f"Convertido {file.name}")
        else:
            _message.error(f"Error al convertir {file.name}")
    else:
        from concurrent.futures import ProcessPoolExecutor, as_completed

        with ProcessPoolExecutor() as executor:
            futures = {executor.submit(convert_video, f): f for f in files}

            for future in as_completed(futures):
                file = futures[future]
                try:
                    if future.result():
                        _message.success(f"Convertido {file.name}")
                    else:
                        _message.error(f"Error al convertir {file.name}")
                except Exception as e:
                    _message.error(f"Error inesperado con {file.name}: {e}")

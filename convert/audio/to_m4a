#!/usr/bin/env python
# ? description: Convert audio to m4a/mp4 format.
# ? usage      : to_m4a [audio(s)]

import sys
from pathlib import Path
from concurrent.futures import ProcessPoolExecutor, as_completed
from subprocess import run, DEVNULL

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _log, _success, _error, _params_required


def convert_audio(input_path: Path) -> tuple[bool, str]:
    """Convert a single audio file to M4A format."""
    output_path = input_path.parent / f"{input_path.stem}.m4a"

    cmd = [
        "ffmpeg", "-y", "-i", str(input_path),
        "-c:v", "copy", "-c:a", "aac", "-strict", "experimental", "-b:a", "192k",
        str(output_path)
    ]

    result = run(cmd, stdout=DEVNULL, stderr=DEVNULL)

    if result.returncode == 0:
        return True, f"Convertido: {input_path.name} -> {output_path.name}"
    else:
        return False, f"Error al convertir {input_path.name}"


if __name__ == "__main__":
    _params_required(1)

    files = [Path(f) for f in sys.argv[1:] if Path(f).exists() and Path(f).is_file()]

    if not files:
        _error("No se encontraron archivos v√°lidos")
        sys.exit(1)

    with ProcessPoolExecutor() as executor:
        futures = {executor.submit(convert_audio, f): f for f in files}

        for future in as_completed(futures):
            file = futures[future]
            _log(f"Procesando: {file.name}")
            try:
                success, message = future.result()
                if success:
                    _success(message)
                else:
                    _error(message)
            except Exception as e:
                _error(f"Error inesperado con {file.name}: {e}")

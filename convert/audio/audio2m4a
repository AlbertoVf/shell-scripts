#!/usr/bin/env python
# ? description: Convert audio to m4a/mp4 format.
# ? usage      : audio2m4a [audio(s)]

import sys
from pathlib import Path
from subprocess import run, DEVNULL

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _message, _params_required, _valid_files


def convert_audio(input_path: Path) -> bool:
    """Convert a single audio file to M4A format."""
    output_path = input_path.parent / f"{input_path.stem}.m4a"
    _message.log(f"Procesando: {input_path.name}")

    result = run(
        ["ffmpeg", "-y", "-i", str(input_path),
         "-c:v", "copy", "-c:a", "aac", "-strict", "experimental", "-b:a", "192k",
         str(output_path)],
        stdout=DEVNULL,
        stderr=DEVNULL,
        check=False
    )
    return result.returncode == 0


if __name__ == "__main__":
    _params_required(1)

    files = _valid_files(sys.argv[1:])

    if len(files) == 1:
        file = files[0]
        if convert_audio(file):
            _message.success(f"Convertido {file.name}")
        else:
            _message.error(f"Error al convertir {file.name}")
    else:
        from concurrent.futures import ProcessPoolExecutor, as_completed

        with ProcessPoolExecutor() as executor:
            futures = {executor.submit(convert_audio, f): f for f in files}

            for future in as_completed(futures):
                file = futures[future]
                try:
                    if future.result():
                        _message.success(f"Convertido {file.name}")
                    else:
                        _message.error(f"Error al convertir {file.name}")
                except Exception as e:
                    _message.error(f"Error inesperado con {file.name}: {e}")

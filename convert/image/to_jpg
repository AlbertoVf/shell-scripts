#!/usr/bin/env python
# ? description: Convert image to jpg format.
# ? usage      : to_jpg [image(s)]

import sys
from pathlib import Path
from concurrent.futures import ProcessPoolExecutor, as_completed
from PIL import Image

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _log, _success, _error, _params_required


def convert_image(input_path: Path) -> tuple[bool, str]:
    """Convert a single image file to JPG format."""
    output_path = input_path.parent / f"{input_path.stem}.jpg"

    try:
        with Image.open(input_path) as img:
            # Convert RGBA to RGB if necessary
            if img.mode in ("RGBA", "LA", "P"):
                rgb_img = Image.new("RGB", img.size, (255, 255, 255))
                if img.mode == "P":
                    img = img.convert("RGBA")
                rgb_img.paste(img, mask=img.split()[-1] if img.mode in ("RGBA", "LA") else None)
                img = rgb_img
            elif img.mode != "RGB":
                img = img.convert("RGB")

            img.save(output_path, "JPEG", quality=100, optimize=True)
        return True, f"Convertido: {input_path.name} -> {output_path.name}"
    except Exception as e:
        return False, f"Error al convertir {input_path.name}: {e}"


if __name__ == "__main__":
    _params_required(1)

    files = [Path(f) for f in sys.argv[1:] if Path(f).exists() and Path(f).is_file()]

    if not files:
        _error("No se encontraron archivos v√°lidos")
        sys.exit(1)

    with ProcessPoolExecutor() as executor:
        futures = {executor.submit(convert_image, f): f for f in files}

        for future in as_completed(futures):
            file = futures[future]
            _log(f"Procesando: {file.name}")
            try:
                success, message = future.result()
                if success:
                    _success(message)
                else:
                    _error(message)
            except Exception as e:
                _error(f"Error inesperado con {file.name}: {e}")

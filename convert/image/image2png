#!/usr/bin/env python
# ? description: Convert image to png format.
# ? usage      : image2png [image(s)]

import sys
from pathlib import Path
from PIL import Image

sys.path.insert(0, str(Path(__file__).parent.parent.parent))
from _main import _log, _success, _error, _params_required


def convert_image(input_path: Path) -> bool:
    """Convert a single image file to PNG format."""
    output_path = input_path.parent / f"{input_path.stem}.png"
    _log(f"Procesando: {input_path.name}")

    try:
        with Image.open(input_path) as img:
            # Convert to RGB if necessary, preserving transparency
            if img.mode == "P" and "transparency" in img.info:
                img = img.convert("RGBA")
            elif img.mode not in ("RGB", "RGBA", "LA"):
                # For images without transparency, convert to RGB
                if img.mode in ("RGBA", "LA"):
                    # Create white background
                    rgb_img = Image.new("RGB", img.size, (255, 255, 255))
                    rgb_img.paste(img, mask=img.split()[-1] if img.mode in ("RGBA", "LA") else None)
                    img = rgb_img
                else:
                    img = img.convert("RGB")

            img.save(output_path, "PNG", optimize=True)
        return True
    except Exception as e:
        _error(f"Error al convertir {input_path.name}: {e}")
        return False


if __name__ == "__main__":
    _params_required(1)

    files = [Path(f) for f in sys.argv[1:] if Path(f).exists() and Path(f).is_file()]

    if not files:
        _error("No se encontraron archivos v√°lidos")
        sys.exit(1)

    if len(files) == 1:
        file = files[0]
        if convert_image(file):
            _success(f"Convertido {file.name}")
    else:
        from concurrent.futures import ProcessPoolExecutor, as_completed

        with ProcessPoolExecutor() as executor:
            futures = {executor.submit(convert_image, f): f for f in files}

            for future in as_completed(futures):
                file = futures[future]
                try:
                    if future.result():
                        _success(f"Convertido {file.name}")
                except Exception as e:
                    _error(f"Error inesperado con {file.name}: {e}")

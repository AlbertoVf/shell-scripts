#!/usr/bin/env sh
# ? description: create a playlist with mp3 and mp4 files in folder.
# ? usage      : create_playlist [directory]

. "$HOME/.bin/_main.sh"


path="${1:-$PWD}"
path="$(realpath "$path")"
folder="$(basename "$path")"

create_m3u8(){
    playlist="$folder.m3u8"
    echo "#EXTM3"| iconv -t UTF-8 > $playlist
    fd . -tf -e mp3 -e mp4 -d1 "$path" | while read -r f; do
        dur=$(ffprobe -v fatal -show_entries format=duration -of csv=p=0 "$f")
        dur_int=${dur%%.*}
        dur_up=$((dur_int + 1))
        base=$(basename "$f")
        base="${base%.*}"
        printf "#EXTINF:%s,%s\n%s\n" "$dur_up" "$base" "$f" >> $playlist
    done
}

create_playlist(){
    playlist="$folder.m3u"
    echo "#!/usr/bin/env mpv" > $playlist
    fd . -tf -e mp3 -e mp4 -d1 "$path" | while read -r f; do
        base=$(basename "$f")
        echo "$f\n" >> $playlist
    done
}

create_m3u8 $path
